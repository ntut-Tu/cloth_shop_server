databaseChangeLog:
  - changeSet:
      id: fix-platform-ledger-function
      author: quinn
      preConditions:
        - onFail: CONTINUE
        - dbms:
            type: postgresql
      changes:
        - sql:
            splitStatements: false
            sql: |
              -- 修正平台台账函数
              CREATE OR REPLACE FUNCTION create_platform_ledger()
              RETURNS TRIGGER AS $$
              DECLARE
                current_balance NUMERIC(10, 2);
              BEGIN
                -- 获取平台最后一笔 total_balance，若无记录则为 0
                SELECT COALESCE(total_balance, 0) INTO current_balance 
                FROM ledger_entry 
                WHERE ledger_type = 'platform'
                ORDER BY ledger_entry_id DESC -- 假设 ID 是递增主键
                LIMIT 1;

                -- 平台抽成
                IF (NEW.total_amount - 60) * 0.05 != 0 THEN
                  INSERT INTO ledger_entry (
                    ledger_type, transaction_type, amount, total_balance, transaction_date, notes, coupon_id
                  )
                  VALUES (
                    'platform', 'income',
                    (NEW.total_amount - 60) * 0.05,
                    current_balance + ((NEW.total_amount - 60) * 0.05),
                    NOW(), '平台抽成', NULL
                  );

                  -- 更新 current_balance
                  SELECT COALESCE(total_balance, 0) INTO current_balance 
                  FROM ledger_entry 
                  WHERE ledger_type = 'platform'
                  ORDER BY ledger_entry_id DESC
                  LIMIT 1;

                  INSERT INTO platform_ledger_entry (
                    ledger_entry_id, order_id
                  ) VALUES (
                    (SELECT ledger_entry_id 
                     FROM ledger_entry 
                     WHERE ledger_type = 'platform'
                     ORDER BY ledger_entry_id DESC
                     LIMIT 1),
                    NEW.order_id
                  );
                END IF;

                -- 平台优惠费用
                IF NEW.shipping_discount_amount != 0 THEN
                  INSERT INTO ledger_entry (
                    ledger_type, transaction_type, amount, total_balance, transaction_date, notes, coupon_id
                  )
                  VALUES (
                    'platform', 'fee',
                    NEW.shipping_discount_amount,
                    current_balance - NEW.shipping_discount_amount,
                    NOW(), '平台优惠费用', NEW.fk_shipping_discount_id
                  );

                  -- 更新 current_balance
                  SELECT COALESCE(total_balance, 0) INTO current_balance 
                  FROM ledger_entry 
                  WHERE ledger_type = 'platform'
                  ORDER BY ledger_entry_id DESC
                  LIMIT 1;

                  INSERT INTO platform_ledger_entry (
                    ledger_entry_id, order_id
                  ) VALUES (
                    (SELECT ledger_entry_id 
                     FROM ledger_entry 
                     WHERE ledger_type = 'platform'
                     ORDER BY ledger_entry_id DESC
                     LIMIT 1),
                    NEW.order_id
                  );
                END IF;

                RETURN NEW;
              END;
              $$ LANGUAGE plpgsql;

              -- 更新触发器
              DROP TRIGGER IF EXISTS order_ship_status_trigger ON "order";
              CREATE TRIGGER order_ship_status_trigger
              AFTER UPDATE OF ship_status ON "order"
              FOR EACH ROW
              WHEN (NEW.ship_status = 'Completed')
              EXECUTE FUNCTION create_platform_ledger();

  - changeSet:
      id: fix-vendor-ledger-function
      author: quinn
      preConditions:
        - onFail: CONTINUE
        - dbms:
            type: postgresql
      changes:
        - sql:
            splitStatements: false
            sql: |
              -- 修正商家台账函数
              CREATE OR REPLACE FUNCTION create_vendor_ledger()
              RETURNS TRIGGER AS $$
              DECLARE
                store_rec RECORD;
                current_balance NUMERIC(10, 2);
              BEGIN
                FOR store_rec IN
                  SELECT * FROM store_order WHERE fk_order_id = NEW.order_id
                LOOP
                  -- 获取商家最后一笔 total_balance，若无记录则为 0
                  SELECT COALESCE(total_balance, 0) INTO current_balance 
                  FROM ledger_entry 
                  WHERE ledger_type = 'vendor'
                    AND ledger_entry_id IN (
                      SELECT ledger_entry_id FROM vendor_ledger_entry WHERE vendor_id = store_rec.fk_vendor_id
                    )
                  ORDER BY ledger_entry_id DESC
                  LIMIT 1;

                  -- 售货收入
                  IF store_rec.store_net_amount * 0.95 != 0 THEN
                    INSERT INTO ledger_entry (
                      ledger_type, transaction_type, amount, total_balance, transaction_date, notes, coupon_id
                    )
                    VALUES (
                      'vendor', 'income',
                      store_rec.store_net_amount * 0.95,
                      current_balance + (store_rec.store_net_amount * 0.95),
                      NOW(), '售货收入', NULL
                    );

                    -- 更新 current_balance
                    SELECT COALESCE(total_balance, 0) INTO current_balance 
                    FROM ledger_entry 
                    WHERE ledger_type = 'vendor'
                      AND ledger_entry_id IN (
                        SELECT ledger_entry_id FROM vendor_ledger_entry WHERE vendor_id = store_rec.fk_vendor_id
                      )
                    ORDER BY ledger_entry_id DESC
                    LIMIT 1;

                    INSERT INTO vendor_ledger_entry (
                      ledger_entry_id, vendor_id, store_order_id
                    ) VALUES (
                      (SELECT ledger_entry_id 
                       FROM ledger_entry 
                       WHERE ledger_type = 'vendor'
                         AND ledger_entry_id IN (
                           SELECT ledger_entry_id 
                           FROM vendor_ledger_entry 
                           WHERE vendor_id = store_rec.fk_vendor_id
                         )
                       ORDER BY ledger_entry_id DESC
                       LIMIT 1),
                      store_rec.fk_vendor_id, store_rec.store_order_id
                    );
                  END IF;

                  -- 优惠费用
                  IF store_rec.store_discount_amount != 0 THEN
                    INSERT INTO ledger_entry (
                      ledger_type, transaction_type, amount, total_balance, transaction_date, notes, coupon_id
                    )
                    VALUES (
                      'vendor', 'fee',
                      store_rec.store_discount_amount,
                      current_balance - store_rec.store_discount_amount,
                      NOW(), '优惠费用',
                      COALESCE(store_rec.seasonal_discount_id, store_rec.special_discount_id)
                    );

                    -- 更新 current_balance
                    SELECT COALESCE(total_balance, 0) INTO current_balance 
                    FROM ledger_entry 
                    WHERE ledger_type = 'vendor'
                      AND ledger_entry_id IN (
                        SELECT ledger_entry_id FROM vendor_ledger_entry WHERE vendor_id = store_rec.fk_vendor_id
                      )
                    ORDER BY ledger_entry_id DESC
                    LIMIT 1;

                    INSERT INTO vendor_ledger_entry (
                      ledger_entry_id, vendor_id, store_order_id
                    ) VALUES (
                      (SELECT ledger_entry_id 
                       FROM ledger_entry 
                       WHERE ledger_type = 'vendor'
                         AND ledger_entry_id IN (
                           SELECT ledger_entry_id 
                           FROM vendor_ledger_entry 
                           WHERE vendor_id = store_rec.fk_vendor_id
                         )
                       ORDER BY ledger_entry_id DESC
                       LIMIT 1),
                      store_rec.fk_vendor_id, store_rec.store_order_id
                    );
                  END IF;
                END LOOP;

                RETURN NEW;
              END;
              $$ LANGUAGE plpgsql;

              -- 更新触发器
              DROP TRIGGER IF EXISTS store_order_status_trigger ON "order";
              CREATE TRIGGER store_order_status_trigger
              AFTER UPDATE OF ship_status ON "order"
              FOR EACH ROW
              WHEN (NEW.ship_status = 'Completed')
              EXECUTE FUNCTION create_vendor_ledger();
