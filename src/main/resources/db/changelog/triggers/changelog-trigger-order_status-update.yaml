databaseChangeLog:
  - changeSet:
      id: order_status_trigger
      author: quinn
      changes:
        - sql:
            splitStatements: true
            stripComments: true
            sql: |
              DELIMITER $$
              
              CREATE TRIGGER trg_update_store_order_status
              AFTER UPDATE ON store_order
              FOR EACH ROW
              BEGIN
                  IF NEW.store_order_status = 'shipped' THEN
                      UPDATE `order` o
                      SET o.status = 'Delivered'
                      WHERE o.order_id = NEW.fk_order_id
                        AND NOT EXISTS (
                            SELECT 1
                            FROM store_order so
                            WHERE so.fk_order_id = NEW.fk_order_id
                              AND so.store_order_status != 'shipped'
                        );
                  END IF;
              END$$
              
              DELIMITER ;
